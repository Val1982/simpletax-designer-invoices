cd /workspaces/simpletax-designer-invoices

python - <<'PY'
import glob, re, pathlib

files = glob.glob(".github/workflows/*.yml") + glob.glob(".github/workflows/*.yaml")
if not files:
    raise SystemExit("No workflow files found in .github/workflows/")

patched = []
for f in files:
    p = pathlib.Path(f)
    s = p.read_text(encoding="utf-8")

    if "git add -A" not in s or "git push" not in s:
        continue

    new_block = """git config user.name "github-actions[bot]"
git config user.email "github-actions[bot]@users.noreply.github.com"

git pull --rebase --autostash

# Commit ONLY generated preview (avoid node_modules)
git add preview/index.html
# optional:
# git add data/last_response.json

git commit -m "Auto: render preview" || echo "No changes to commit"
git push
"""

    s2, n = re.subn(r"git add -A[\\s\\S]*?git push", new_block.strip(), s, count=1)
    if n:
        p.write_text(s2, encoding="utf-8")
        patched.append(f)

print("Patched:", patched if patched else "No files patched (maybe your workflow uses different git commands)")
PY

git add .github/workflows
git commit -m "Fix workflow: commit only preview" || echo "No workflow changes to commit"
git push
