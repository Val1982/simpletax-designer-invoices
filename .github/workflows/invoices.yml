import fs from "fs";

const endpoint = process.env.EF_ENDPOINT;
const username = process.env.EF_USERNAME;
const token = process.env.EF_TOKEN;

if (!endpoint || !username || !secretKey || !token) {
  throw new Error("Missing EF_* env vars. Check GitHub Secrets.");
}

async function efCall(method, parameters = {}) {
  const res = await fetch(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, secretKey, token, method, parameters })
  });

  const text = await res.text();

  fs.mkdirSync("data", { recursive: true });
  fs.writeFileSync("data/last_response.txt", text);

  let data;
  try {
    data = JSON.parse(text);
  } catch {
    fs.writeFileSync("data/error.html", text);
    throw new Error(`Non-JSON response (${res.status}). Saved to data/error.html`);
  }

  if (!res.ok) {
    fs.writeFileSync("data/error.json", JSON.stringify(data, null, 2));
    throw new Error(`HTTP ${res.status}. Saved to data/error.json`);
  }

  return data;
}

async function main() {
  // За начало: дърпаме списък (до 500) – само issued
  const data = await efCall("SalesInvoiceList", {
    status: "IssuedInvoice"
  });

  fs.mkdirSync("data", { recursive: true });
  fs.writeFileSync("data/sample.json", JSON.stringify(data, null, 2));

  console.log("OK. Saved response to data/sample.json and data/last_response.txt");
}

await main();
